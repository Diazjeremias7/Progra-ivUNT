const { spawn } = require('child_process');
const fs = require('fs');
const path = require('path');
const { db } = require('../config/database');
const { validatePingHost } = require('../utils/validators');
const { logCommandInjectionAttempt, logAccessDenied } = require('../utils/securityLogger');

// Función helper para ejecutar ping de forma segura
const executePing = (host) => {
  return new Promise((resolve, reject) => {
    const isWindows = process.platform === 'win32';
    const pingCommand = isWindows ? 'ping' : 'ping';
    const pingArgs = isWindows ? ['-n', '4', host] : ['-c', '4', host];
    
    const pingProcess = spawn(pingCommand, pingArgs);
    
    let output = '';
    let errorOutput = '';
    
    pingProcess.stdout.on('data', (data) => {
      output += data.toString();
    });
    
    pingProcess.stderr.on('data', (data) => {
      errorOutput += data.toString();
    });
    
    pingProcess.on('close', (code) => {
      if (code === 0) {
        resolve(output);
      } else {
        reject(new Error('Error al ejecutar ping'));
      }
    });
    
    pingProcess.on('error', (error) => {
      reject(new Error('Error al ejecutar el comando'));
    });
    
    setTimeout(() => {
      pingProcess.kill();
      reject(new Error('Timeout: el comando tardó demasiado'));
    }, 10000);
  });
};

// CORREGIDO: Command Injection con logging
const ping = async (req, res) => {
  const { host } = req.body;
  
  // Detectar y registrar intentos sospechosos
  logCommandInjectionAttempt(req, host);
  
  // Validar la entrada
  const validation = validatePingHost(host);
  
  if (!validation.valid) {
    logAccessDenied(req, 'Invalid host format', host);
    
    return res.status(400).json({ 
      error: 'Host inválido',
      details: validation.errors 
    });
  }
  
  try {
    // Ejecutar ping de forma segura
    const output = await executePing(host);
    
    res.json({ 
      output,
      host,
      message: 'Ping ejecutado correctamente'
    });
  } catch (error) {
    // No exponer detalles internos del error
    console.error('Ping error:', error);
    res.status(500).json({ 
      error: 'Error al ejecutar ping',
      message: 'No se pudo completar la operación'
    });
  }
};

// CSRF - Transferencia sin token CSRF
const transfer = (req, res) => {
  const { fromAccount, toAccount, amount } = req.body;
  
  if (!req.session.userId) {
    return res.status(401).json({ error: 'No autenticado' });
  }
  
  const query = 'INSERT INTO transfers (from_account, to_account, amount, user_id) VALUES (?, ?, ?, ?)';
  db.query(query, [fromAccount, toAccount, amount, req.session.userId], (err) => {
    if (err) {
      return res.status(500).json({ error: 'Error en la transferencia' });
    }
    res.json({ message: 'Transferencia realizada con éxito' });
  });
};

// Local File Inclusion
const readFile = (req, res) => {
  const { filename } = req.query;
  
  const filePath = path.join(__dirname, '../files', filename);
  
  fs.readFile(filePath, 'utf8', (err, data) => {
    if (err) {
      return res.status(404).json({ error: 'Archivo no encontrado' });
    }
    res.send(data);
  });
};

module.exports = {
  ping,
  transfer,
  readFile
};